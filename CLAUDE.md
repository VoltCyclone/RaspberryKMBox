# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

PIOKMbox is a dual-role USB HID firmware for RP2350 boards (Adafruit Metro RP2350 / Pico 2). It creates a transparent USB passthrough device (mouse/keyboard) while providing KMBox-compatible serial control for input injection with humanization algorithms. Written in C targeting the Pico SDK.

## Build Commands

```bash
# Prerequisites: arm-none-eabi-gcc, CMake 3.13+, Pico SDK 2.2.0
export PICO_SDK_PATH=$HOME/.pico-sdk/sdk/2.2.0-fresh

./build.sh metro              # Build main KMBox for Adafruit Metro RP2350
./build.sh pico2              # Build main KMBox for Pico 2 (RP2350)
./build.sh metro flash        # Build and flash via picotool
./build.sh bridge             # Build UART bridge firmware (Metro + ILI9341)
./build.sh bridge-feather     # Build bridge for Feather RP2350
./build.sh bridge-fpga        # Build FPGA bridge for pico2-ice
./build.sh both               # Build metro + pico2
./build.sh flash-metros       # Build and flash both Metros (default target)
./build.sh all clean          # Full clean rebuild of everything
```

Build outputs go to `build-metro/`, `build-pico2/`, `bridge/build-metro/`, etc.

There are no unit tests — testing is done on hardware by flashing firmware and verifying USB passthrough and serial protocol behavior.

## Architecture

### Dual-Core Model (RP2350)
- **Core 0**: USB device mode (TinyUSB, passthrough to PC), serial command processing (UART), LED control, watchdog
- **Core 1**: USB host mode (PIO-USB) connecting physical mouse/keyboard

### Three Firmware Targets
1. **Main KMBox** (`PIOKMbox.c` entry point) — USB passthrough + serial command injection, 240MHz
2. **Bridge** (`bridge/main.c`) — companion board with ILI9341 TFT display, protocol translation, connects to main board via UART at 3 Mbaud
3. **FPGA Bridge** (`bridge-fpga/`) — pico2-ice board (iCE40 UP5K + RP2350), hardware-accelerated UART protocol handling

### Data Flow
```
Physical Mouse/Keyboard → Core 1 (PIO-USB Host) → Core 0 → USB Device (TinyUSB) → PC
                                                      ↑
                                        UART RX (3 Mbaud) ← Bridge/PC sends KMBox commands
                                                      ↓
                                        Smooth Injection → Humanization → HID report merge
```

### Key Source Files
| File | Role |
|------|------|
| `PIOKMbox.c` | Main entry point, core orchestration, main loop |
| `usb_hid.c/h` | USB host+device implementation, VID/PID mirroring, HID report forwarding |
| `kmbox_serial_handler.c/h` | KMBox/Macku/Ferrum UART protocol handler |
| `smooth_injection.c/h` | Movement smoothing engine with sub-pixel 16.16 fixed-point accumulators |
| `humanization_fpu.c/h` | Runtime jitter generation (layered sine oscillators) |
| `humanization_lut.c/h` | Precomputed jitter lookup tables (generated by `tools/generate_lut.py`) |
| `led_control.c/h` | NeoPixel/LED status display with DMA |
| `watchdog.c/h` | Dual-core health monitoring, hardware watchdog |
| `state_management.c/h` | System state coordination between cores |
| `defines.h` | Consolidated project-wide defines and constants |
| `config.h` | Build configuration overrides (DEVELOPMENT/PRODUCTION/TESTING/DEBUG) |
| `tusb_config.h` | TinyUSB stack configuration |
| `bridge_protocol.h` | Binary bridge protocol definitions (sync byte 0xBD) |

### Libraries
- `lib/Pico-PIO-USB/` — PIO-based USB host stack (git submodule)
- `lib/kmbox-commands/` — KMBox protocol parser (text + binary commands)
- `lib/bridge-protocol/` — Bridge protocol definitions

### Build System
- CMake-based with `pico_sdk_import.cmake`; board-specific pin configs set via CMake cache variables
- Compiler flags: `-O3 -ffast-math -funroll-loops` with link-time dead code elimination
- Board selection via `PICO_BOARD` CMake variable (set by `build.sh` target)
- Custom board header in `boards/adafruit_metro_rp2350.h`

## Key Constants & Hardware Config

- **CPU**: 240MHz (overclocked)
- **UART**: 3 Mbaud on UART0 (exact divisor at 48MHz peripheral clock)
- **USB Host pins**: Metro=GPIO 32/33, Pico2=GPIO 16/17
- **NeoPixel**: Metro=GPIO 25, Pico2=GPIO 21
- **Build configs**: `BUILD_CONFIG_DEVELOPMENT` (default), `BUILD_CONFIG_PRODUCTION`, `BUILD_CONFIG_TESTING`, `BUILD_CONFIG_DEBUG`

## Humanization System

Four modes (OFF/LOW/MEDIUM/HIGH) controlled by button press on the board. The system uses movement-aware jitter scaling, velocity-based suppression, overshoot simulation, and per-session randomization. Detailed docs in `HUMANIZATION.md`. Humanization is never applied to physical input — only to injected movements.

## Protocols

- **KMBox binary**: 8-byte fixed packets, <50us latency
- **KMBox text**: ASCII commands like `km.move(x, y)`, `km.click(button)`
- **Bridge mini-protocol**: 2-7 byte packets with 0xBD sync byte over 3 Mbaud UART
- **Macku/Ferrum**: Supported via bridge protocol translators

## CI/CD

GitHub Actions workflows in `.github/workflows/`: `build-ci.yml` (PR validation) and `build-release.yml` (tagged releases build and upload binaries).
